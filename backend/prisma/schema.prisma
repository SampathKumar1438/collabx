// Prisma schema for FullStack Chat Application
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  userId            String    @id @default(uuid()) @map("user_id")
  username          String    @db.VarChar(50)
  email             String    @unique @db.VarChar(100)
  passwordHash      String    @map("password_hash") @db.Text
  profilePictureUrl String?   @map("profile_picture_url") @db.Text
  bio               String?   @db.Text
  profileComplete   Boolean   @default(false) @map("profile_complete")
  isOnline          Boolean   @default(false) @map("is_online")
  lastActiveAt      DateTime? @default(now()) @map("last_active_at") @db.Timestamp(6)
  createdAt         DateTime  @default(now()) @map("created_at") @db.Timestamp(6)
  
  // Email verification fields
  emailVerified              Boolean   @default(false) @map("email_verified")
  emailVerificationToken     String?   @map("email_verification_token") @db.VarChar(255)
  emailVerificationExpires   DateTime? @map("email_verification_expires") @db.Timestamp(6)
  
  // Password reset fields
  passwordResetToken   String?   @map("password_reset_token") @db.VarChar(255)
  passwordResetExpires DateTime? @map("password_reset_expires") @db.Timestamp(6)



  // Relations
  createdConversations Conversation[] @relation("ConversationCreator")
  participants         Participant[]
  sentMessages         Message[]

  @@map("users")
}

model Conversation {
  conversationId String    @id @default(uuid()) @map("conversation_id")
  type           String    @db.VarChar(10) // 'private' or 'group'
  groupName      String?   @map("group_name") @db.VarChar(100)
  groupImageUrl  String?   @map("group_image_url") @db.Text
  createdBy      String?   @map("created_by")
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt      DateTime  @updatedAt @map("updated_at") @db.Timestamp(6)

  // Relations
  creator      User?         @relation("ConversationCreator", fields: [createdBy], references: [userId], onDelete: SetNull)
  participants Participant[]
  messages     Message[]

  @@index([type])
  @@index([createdBy])
  @@index([updatedAt])
  @@map("conversations")
}

model Participant {
  participantId   String    @id @default(uuid()) @map("participant_id")
  conversationId  String    @map("conversation_id")
  userId          String    @map("user_id")
  role            String    @default("member") @db.VarChar(20) // 'admin' or 'member'
  joinedAt        DateTime  @default(now()) @map("joined_at") @db.Timestamp(6)
  lastReadAt      DateTime  @default(now()) @map("last_read_at") @db.Timestamp(6)

  // Relations
  conversation Conversation @relation(fields: [conversationId], references: [conversationId], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@unique([conversationId, userId])
  @@index([conversationId])
  @@index([userId])
  @@map("participants")
}

model Message {
  messageId      String    @id @default(uuid()) @map("message_id")
  conversationId String    @map("conversation_id")
  senderId       String?   @map("sender_id")
  content        String?   @db.Text
  messageType    String    @default("text") @db.VarChar(20) // 'text', 'image', 'audio', 'video', 'file', 'call_log'
  fileUrl        String?   @map("file_url") @db.Text
  metadata       Json      @default("{}")
  status         String    @default("sent") @db.VarChar(20) // 'sent', 'delivered', 'read'
  isDeleted      Boolean   @default(false) @map("is_deleted")
  isPinned       Boolean   @default(false) @map("is_pinned")
  isEdited       Boolean   @default(false) @map("is_edited")
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamp(6)

  // Relations
  conversation Conversation @relation(fields: [conversationId], references: [conversationId], onDelete: Cascade)
  sender       User?        @relation(fields: [senderId], references: [userId], onDelete: SetNull)

  @@index([conversationId, createdAt])
  @@index([senderId])
  @@index([createdAt])
  @@map("messages")
}
